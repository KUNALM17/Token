// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  HOSPITAL_ADMIN
  DOCTOR
  PATIENT
}

enum AppointmentStatus {
  BOOKED
  CALLED
  COMPLETED
  SKIPPED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model User {
  id            String   @id @default(uuid())
  name          String?
  phone         String   @unique
  email         String?
  role          UserRole
  hospitalId    String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  hospital      Hospital?       @relation(fields: [hospitalId], references: [id], onDelete: SetNull)
  doctorProfile Doctor?
  appointments  Appointment[]
  otps          OTP[]

  @@index([hospitalId])
  @@index([role])
}

model Hospital {
  id        String   @id @default(uuid())
  name      String
  address   String
  city      String
  state     String
  phone     String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  doctors      Doctor[]
  appointments Appointment[]

  @@index([isActive])
}

model Doctor {
  id               String   @id @default(uuid())
  userId           String   @unique
  hospitalId       String
  specialization   String
  consultationFee  Float
  dailyTokenLimit  Int      @default(50)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  hospital         Hospital       @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  appointments     Appointment[]

  @@index([hospitalId])
  @@index([userId])
  @@index([isActive])
}

model Appointment {
  id              String             @id @default(uuid())
  patientId       String
  doctorId        String
  hospitalId      String
  appointmentDate String             // YYYY-MM-DD format
  tokenNumber     Int
  status          AppointmentStatus  @default(BOOKED)
  paymentStatus   PaymentStatus      @default(PENDING)
  paymentId       String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  patient         User              @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor          Doctor            @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  hospital        Hospital          @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  payment         Payment?

  @@unique([doctorId, appointmentDate, tokenNumber])
  @@index([patientId])
  @@index([doctorId])
  @@index([hospitalId])
  @@index([appointmentDate])
  @@index([status])
}

model Payment {
  id                  String        @id @default(uuid())
  appointmentId       String        @unique
  amount              Float
  provider            String        // "razorpay"
  providerPaymentId   String?       // Razorpay order ID or payment ID
  status              PaymentStatus @default(PENDING)
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  appointment         Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([appointmentId])
}

model OTP {
  id        String   @id @default(uuid())
  userId    String?
  phone     String
  code      String
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([phone])
  @@index([isUsed])
}
