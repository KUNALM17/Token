generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            Int           @id @default(autoincrement())
  phone         String        @unique @db.VarChar(15)
  name          String?       @db.VarChar(255)
  email         String?       @db.VarChar(255)
  role          String        @default("PATIENT") @db.VarChar(50)
  hospitalId    Int?
  isActive      Boolean?      @default(true)
  createdAt     DateTime?     @default(now()) @db.Timestamp(6)
  updatedAt     DateTime?     @default(now()) @db.Timestamp(6)
  age           Int?
  city          String?       @db.VarChar(100)
  gender        String?       @db.VarChar(20)
  weight        Int?
  appointments  Appointment[]
  doctorProfile Doctor?
  otps          OTP[]

  @@index([phone], map: "idx_user_phone")
  @@index([role], map: "idx_user_role")
}

model Hospital {
  id           Int           @id @default(autoincrement())
  name         String        @db.VarChar(255)
  address      String?       @db.VarChar(500)
  city         String?       @db.VarChar(100)
  state        String?       @db.VarChar(100)
  phone        String?       @db.VarChar(15)
  isActive     Boolean?      @default(true)
  createdAt    DateTime?     @default(now()) @db.Timestamp(6)
  updatedAt    DateTime?     @default(now()) @db.Timestamp(6)
  appointments Appointment[]
  doctors      Doctor[]
}

model Doctor {
  id              Int           @id @default(autoincrement())
  userId          Int?          @unique
  hospitalId      Int?
  specialization  String?       @db.VarChar(255)
  consultationFee Int?
  dailyTokenLimit Int?          @default(50)
  isActive        Boolean?      @default(true)
  createdAt       DateTime?     @default(now()) @db.Timestamp(6)
  updatedAt       DateTime?     @default(now()) @db.Timestamp(6)
  appointments    Appointment[]
  hospital        Hospital?     @relation(fields: [hospitalId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user            User?         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([hospitalId], map: "idx_doctor_hospital")
}

model Appointment {
  id              Int       @id @default(autoincrement())
  patientId       Int?
  doctorId        Int?
  hospitalId      Int?
  appointmentDate String?   @db.VarChar(10)
  tokenNumber     Int?
  status          String?   @default("BOOKED") @db.VarChar(50)
  paymentStatus   String?   @default("PENDING") @db.VarChar(50)
  paymentId       Int?
  createdAt       DateTime? @default(now()) @db.Timestamp(6)
  updatedAt       DateTime? @default(now()) @db.Timestamp(6)
  doctor          Doctor?   @relation(fields: [doctorId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  hospital        Hospital? @relation(fields: [hospitalId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  patient         User?     @relation(fields: [patientId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  payment         Payment?

  @@unique([doctorId, appointmentDate, tokenNumber])
  @@index([appointmentDate], map: "idx_appointment_date")
  @@index([doctorId], map: "idx_appointment_doctor")
  @@index([patientId], map: "idx_appointment_patient")
}

model Payment {
  id                Int          @id @default(autoincrement())
  appointmentId     Int?         @unique
  amount            Int?
  provider          String?      @db.VarChar(50)
  providerPaymentId String?      @db.VarChar(255)
  status            String?      @db.VarChar(50)
  createdAt         DateTime?    @default(now()) @db.Timestamp(6)
  updatedAt         DateTime?    @default(now()) @db.Timestamp(6)
  appointment       Appointment? @relation(fields: [appointmentId], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model OTP {
  id        Int       @id @default(autoincrement())
  userId    Int?
  phone     String?   @db.VarChar(15)
  code      String?   @db.VarChar(6)
  expiresAt DateTime? @db.Timestamp(6)
  isUsed    Boolean?  @default(false)
  createdAt DateTime? @default(now()) @db.Timestamp(6)
  user      User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([expiresAt], map: "idx_otp_expires")
  @@index([phone], map: "idx_otp_phone")
}
