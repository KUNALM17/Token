generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id         Int       @id @default(autoincrement())
  phone      String    @unique @db.VarChar(15)
  name       String?   @db.VarChar(255)
  email      String?   @db.VarChar(255)
  role       String    @default("PATIENT") @db.VarChar(50)
  hospitalId Int?
  age        Int?
  gender     String?   @db.VarChar(20)
  weight     Int?
  city       String?   @db.VarChar(100)
  isActive   Boolean?  @default(true)
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @default(now())

  hospital      Hospital?     @relation(fields: [hospitalId], references: [id], onDelete: SetNull)
  doctorProfile Doctor?
  appointments  Appointment[]
  otps          OTP[]

  @@index([phone], map: "idx_user_phone")
  @@index([role], map: "idx_user_role")
}

model Hospital {
  id                  Int       @id @default(autoincrement())
  name                String    @db.VarChar(255)
  address             String?   @db.VarChar(500)
  city                String?   @db.VarChar(100)
  state               String?   @db.VarChar(100)
  phone               String?   @db.VarChar(15)
  maxBookingDaysAhead Int?      @default(7)
  isActive            Boolean?  @default(true)
  createdAt           DateTime? @default(now())
  updatedAt           DateTime? @default(now())

  users        User[]
  doctors      Doctor[]
  appointments Appointment[]
}

model Doctor {
  id              Int       @id @default(autoincrement())
  userId          Int       @unique
  hospitalId      Int
  specialization  String?   @db.VarChar(255)
  consultationFee Int?
  avgConsultTime  Int?      @default(5)
  isActive        Boolean?  @default(true)
  createdAt       DateTime? @default(now())
  updatedAt       DateTime? @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  hospital     Hospital      @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  shifts       DoctorShift[]
  leaves       DoctorLeave[]

  @@index([hospitalId], map: "idx_doctor_hospital")
}

model DoctorShift {
  id          Int       @id @default(autoincrement())
  doctorId    Int
  shiftName   String    @default("General") @db.VarChar(100)
  startTime   String    @default("09:00") @db.VarChar(10)
  endTime     String    @default("17:00") @db.VarChar(10)
  tokenLimit  Int       @default(50)
  workingDays String?   @default("1,2,3,4,5") @db.VarChar(20)
  isActive    Boolean?  @default(true)
  createdAt   DateTime? @default(now())
  updatedAt   DateTime? @default(now())

  doctor       Doctor        @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  leaves       DoctorLeave[]

  @@index([doctorId], map: "idx_doctor_shift_doctor")
}

model Appointment {
  id              Int       @id @default(autoincrement())
  patientId       Int
  doctorId        Int
  hospitalId      Int
  shiftId         Int?
  appointmentDate String?   @db.VarChar(10)
  tokenNumber     Int?
  status          String?   @default("PENDING") @db.VarChar(50)
  paymentStatus   String?   @default("PENDING") @db.VarChar(50)
  paymentId       Int?
  createdAt       DateTime? @default(now())
  updatedAt       DateTime? @default(now())

  patient  User         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor   Doctor       @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  hospital Hospital     @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  shift    DoctorShift? @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  payment  Payment?

  @@unique([doctorId, shiftId, appointmentDate, tokenNumber])
  @@index([appointmentDate], map: "idx_appointment_date")
  @@index([doctorId], map: "idx_appointment_doctor")
  @@index([patientId], map: "idx_appointment_patient")
  @@index([shiftId], map: "idx_appointment_shift")
}

model Payment {
  id                Int       @id @default(autoincrement())
  appointmentId     Int       @unique
  amount            Int?
  provider          String?   @db.VarChar(50)
  providerPaymentId String?   @db.VarChar(255)
  status            String?   @db.VarChar(50)
  createdAt         DateTime? @default(now())
  updatedAt         DateTime? @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
}

model DoctorLeave {
  id        Int       @id @default(autoincrement())
  doctorId  Int
  leaveDate String    @db.VarChar(10)
  shiftId   Int?
  reason    String?   @db.VarChar(255)
  createdBy String?   @default("ADMIN") @db.VarChar(20)
  notified  Boolean?  @default(false)
  createdAt DateTime? @default(now())
  updatedAt DateTime? @default(now())

  doctor Doctor       @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  shift  DoctorShift? @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@unique([doctorId, leaveDate, shiftId])
  @@index([doctorId], map: "idx_doctor_leave_doctor")
  @@index([leaveDate], map: "idx_doctor_leave_date")
}

model OTP {
  id        Int       @id @default(autoincrement())
  userId    Int?
  phone     String?   @db.VarChar(15)
  code      String?   @db.VarChar(6)
  expiresAt DateTime?
  isUsed    Boolean?  @default(false)
  createdAt DateTime? @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone], map: "idx_otp_phone")
  @@index([expiresAt], map: "idx_otp_expires")
}
